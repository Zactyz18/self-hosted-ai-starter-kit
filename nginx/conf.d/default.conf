# Map for WebSocket upgrade. It's good practice to have this.
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 80;
    server_name localhost;

    # Allow large file uploads (for PDF classification)
    client_max_body_size 100M;

    # Proxy requests for / to the frontend service
    location / {
        proxy_pass http://frontend:3000; # Assuming frontend runs on port 3000
        proxy_http_version 1.1;
        
        # WebSocket support for Vite HMR
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering for real-time communication
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # Proxy requests for /n8n/ to the n8n service
    location /n8n/ {
        # Allow large file uploads for PDF processing
        client_max_body_size 100M;
        
        proxy_pass http://n8n:5678/; # Forward to n8n service, note the trailing slash
                                     # This strips /n8n/ before sending to the n8n container,
                                     # so n8n sees requests as if they are to its root.
                                     # n8n must be configured to expect this base path.

        proxy_http_version 1.1;
        # Headers for WebSocket support (crucial for n8n UI and webhooks)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade; # Uses the map defined above

        # Standard proxy headers
        proxy_set_header Host $host; # This will be localhost
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Will be http

        # Disable buffering for real-time communication
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # Redirect /pgadmin to direct port access
    location /pgadmin {
        return 301 http://$host:5050/;
    }
    
    # Alternative: Simple proxy without subdirectory (commented out)
    # location /pgadmin/ {
    #     proxy_pass http://pgadmin:80/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Script-Name /pgadmin;
    #     proxy_redirect off;
    # }
}

# ============================================================================
# PRODUCTION CONFIGURATION (for AWS EC2 with Load Balancer)
# ============================================================================
# 
# For production deployment on AWS EC2 behind an Application Load Balancer (ALB):
# 
# 1. The ALB handles SSL termination and forwards HTTP traffic to EC2 on port 80
# 2. Domain: llm.iswhub.com (configured in ALB target group)
# 3. ALB routes:
#    - https://llm.iswhub.com/ → EC2:80/ (frontend)
#    - https://llm.iswhub.com/n8n/ → EC2:80/n8n/ (n8n)
# 
# Required .env changes for production:
# - NEXT_PUBLIC_N8N_URL=https://llm.iswhub.com/n8n/
# - N8N_EDITOR_BASE_URL=https://llm.iswhub.com/n8n/
# - N8N_PUBLIC_URL=https://llm.iswhub.com/n8n/
# - WEBHOOK_URL=https://llm.iswhub.com/n8n/webhook/
# - N8N_CORS_ALLOWED_ORIGINS=https://llm.iswhub.com
# 
# server {
#     listen 80;
#     server_name llm.iswhub.com;
# 
#     # Proxy requests for / to the frontend service
#     location / {
#         proxy_pass http://frontend:3000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;  # ALB terminates SSL
#         proxy_set_header X-Forwarded-Host $host;
#     }
# 
#     # Proxy requests for /n8n/ to the n8n service
#     location /n8n/ {
#         proxy_pass http://n8n:5678/;
#         proxy_http_version 1.1;
#         
#         # WebSocket support (crucial for n8n)
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection $connection_upgrade;
#         
#         # Standard proxy headers for ALB setup
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;  # ALB terminates SSL
#         proxy_set_header X-Forwarded-Host $host;
#         
#         # Disable buffering for real-time communication
#         proxy_buffering off;
#         proxy_cache_bypass $http_upgrade;
#     }
# }
